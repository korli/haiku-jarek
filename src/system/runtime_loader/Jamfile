SubDir HAIKU_TOP src system runtime_loader ;


local architectureObject ;
for architectureObject in [ MultiArchSubDirSetup ] {
	on $(architectureObject) {
		local architecture = $(TARGET_PACKAGING_ARCH) ;

		UsePrivateHeaders libroot runtime_loader shared ;
		UsePrivateHeaders kernel ;
			# for <util/KMessage.h>
		UsePrivateHeaders libroot os ;
			# for "PathBuffer.h"
		UsePrivateSystemHeaders ;

		SubDirSysHdrs $(HAIKU_TOP) src libs unwind include ;
		SubDirSysHdrs $(HAIKU_TOP) src libs libc++abi include ;

		ObjectHdrs find_directory.cpp : $(HAIKU_TOP)/src/system/libroot/os ;

		local libCxxBaseDir = [ FDirName $(HAIKU_TOP) src libs libcxx include ] ;

		# Don't let gcc inject built-in function code. This will cause
		# dependencies to libroot, which we don't link against.
		SubDirCcFlags -fno-builtin ;
		SubDirC++Flags -fno-builtin -fno-exceptions -I$(libCxxBaseDir) -Wno-error ;

		DEFINES +=
			KMESSAGE_CONTAINER_ONLY
			_LOADER_MODE
			USING_LIBGCC=1
		;

		AddResources [ MultiArchDefaultGristFiles runtime_loader ]
			: runtime_loader.rdef ;

		local loaderCxxAbiSources =
		  	cxa_aux_runtime.cpp
		  	cxa_default_handlers.cpp
		  	cxa_demangle.cpp
		  	cxa_exception_storage.cpp
		  	cxa_guard.cpp
		  	cxa_handlers.cpp
		  	cxa_unexpected.cpp
		  	cxa_vector.cpp
		  	cxa_virtual.cpp
		  	stdlib_exception.cpp
		  	stdlib_stdexcept.cpp
		  	stdlib_typeinfo.cpp
		  	abort_message.cpp
		  	fallback_malloc.cpp
			private_typeinfo.cpp
			stdlib_new_delete.cpp
			cxa_noexception.cpp
			;
		
		local loaderCxxSources =
			new.cpp
			;

		# needed for "runtime_loader" only
		StaticLibrary <$(architecture)>libruntime_loader.a :
			kernel_vsprintf.cpp
			kernel_cpp.cpp
			KMessage.cpp
			find_directory.cpp
			$(loaderCxxSources)
			:
			<src!system!libroot!os!$(architecture)>mutex.o
			<src!system!libroot!os!$(architecture)>recursive_lock.o
			<src!system!libroot!os!$(architecture)>syscalls.o
			<src!system!libroot!os!$(architecture)>sem.o
			<src!system!libroot!os!arch!$(TARGET_ARCH)!$(architecture)>tls.o

			<src!system!libroot!posix!$(architecture)>errno.o
			<src!system!libroot!posix!$(architecture)>fcntl.o

			<src!system!libroot!posix!locale!$(architecture)>ctype.o
			<src!system!libroot!posix!locale!$(architecture)>LocaleData.o

			<src!system!libroot!posix!string!$(architecture)>memchr.o
			<src!system!libroot!posix!string!$(architecture)>memcmp.o
			<src!system!libroot!posix!string!$(architecture)>memmove.o
			<src!system!libroot!posix!string!$(architecture)>strcasecmp.o
			<src!system!libroot!posix!string!$(architecture)>strcat.o
			<src!system!libroot!posix!string!$(architecture)>strchr.o
			<src!system!libroot!posix!string!$(architecture)>strcmp.o
			<src!system!libroot!posix!string!$(architecture)>strcpy.o
			<src!system!libroot!posix!string!$(architecture)>strcspn.o
			<src!system!libroot!posix!string!$(architecture)>strdup.o
			<src!system!libroot!posix!string!$(architecture)>strerror.o
			<src!system!libroot!posix!string!$(architecture)>strlcat.o
			<src!system!libroot!posix!string!$(architecture)>strlcpy.o
			<src!system!libroot!posix!string!$(architecture)>strlen.o
			<src!system!libroot!posix!string!$(architecture)>strncmp.o
			<src!system!libroot!posix!string!$(architecture)>strnlen.o
			<src!system!libroot!posix!string!$(architecture)>strpbrk.o
			<src!system!libroot!posix!string!$(architecture)>strrchr.o
			<src!system!libroot!posix!string!$(architecture)>strspn.o
			<src!system!libroot!posix!string!$(architecture)>strstr.o
		;

		SEARCH on [ FGristFiles kernel_cpp.cpp ]
			= [ FDirName $(HAIKU_TOP) src system kernel util ] ;
		SEARCH on [ FGristFiles kernel_vsprintf.cpp ]
			= [ FDirName $(HAIKU_TOP) src system kernel lib ] ;
		SEARCH on [ FGristFiles KMessage.cpp ]
			= [ FDirName $(HAIKU_TOP) src system kernel messaging ] ;
		SEARCH on [ FGristFiles find_directory.cpp ]
			= [ FDirName $(HAIKU_TOP) src system libroot os ] ;
		SEARCH on [ FGristFiles $(loaderCxxAbiSources) ]
			= [ FDirName $(HAIKU_TOP) src libs libc++abi src ] ;
		SEARCH on [ FGristFiles $(loaderCxxSources) ]
			= [ FDirName $(HAIKU_TOP) src libs libcxx src ] ;

		local sources =
			add_ons.cpp
			elf.cpp
			elf_haiku_version.cpp
			elf_load_image.cpp
			elf_symbol_lookup.cpp
			elf_tls.cpp
			elf_versioning.cpp
			pe.cpp
			errors.cpp
			export.cpp
			heap.cpp
			images.cpp
			runtime_loader.cpp
			utility.cpp
		;

		Objects $(sources) ;

		Ld [ MultiArchDefaultGristFiles runtime_loader ] :
			[ FGristFiles $(sources:S=$(SUFOBJ)) ]
			<$(architecture)>libruntime_loader.a
			<$(architecture)>libruntime_loader_$(TARGET_ARCH).a
			: $(HAIKU_TOP)/src/system/ldscripts/$(TARGET_ARCH)/runtime_loader.ld
			: --no-undefined -shared -soname=runtime_loader
		;
	}
}


local arch ;
for arch in $(TARGET_ARCHS) {
	HaikuSubInclude arch $(arch) ;
}

